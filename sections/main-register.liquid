{{ 'customer.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  .file-upload-container {
    margin: 20px 0;
    padding: 15px;
    border: 2px dashed #ddd;
    border-radius: 8px;
    background-color: #f9f9f9;
    display: none;
  }

  .file-upload-container.show {
    display: block;
  }

  .upload-btn {
    background: #007cba;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 10px;
  }

  .upload-btn:hover {
    background: #005a87;
  }

  .upload-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .file-info {
    margin-top: 8px;
    padding: 8px;
    border-radius: 4px;
    font-size: 14px;
  }

  .file-info.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .file-info.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .registration-type-selector {
    margin: 20px 0 30px;
    padding: 20px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid #ddd;
  }

  .registration-type-selector h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
    font-weight: 600;
  }

  .registration-type-options {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }

  .registration-type-options label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 16px;
    padding: 10px 15px;
    border: 2px solid #ddd;
    border-radius: 5px;
    background: white;
    transition: all 0.3s ease;
  }

  .registration-type-options label:hover {
    border-color: #5B3C94;
    background: #f5f5f5;
  }

  .registration-type-options input[type="radio"] {
    margin-right: 8px;
    cursor: pointer;
  }

  .registration-type-options input[type="radio"]:checked + span {
    font-weight: 600;
  }

  .registration-type-options label:has(input[type="radio"]:checked) {
    border-color: #5B3C94;
    background: #f0e8ff;
  }

  .hcp-fields {
    display: none;
    transition: opacity 0.3s ease;
  }

  .hcp-fields.show {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

{%- endstyle -%}

<div class="customer register section-{{ section.id }}-padding">
  <svg style="display: none">
    <symbol id="icon-error" viewBox="0 0 13 13">
      <circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
      <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
      <path d="M5.87413 3.52832L5.97439 7.57216H7.02713L7.12739 3.52832H5.87413ZM6.50076 9.66091C6.88091 9.66091 7.18169 9.37267 7.18169 9.00504C7.18169 8.63742 6.88091 8.34917 6.50076 8.34917C6.12061 8.34917 5.81982 8.63742 5.81982 9.00504C5.81982 9.37267 6.12061 9.66091 6.50076 9.66091Z" fill="white"/>
      <path d="M5.87413 3.17832H5.51535L5.52424 3.537L5.6245 7.58083L5.63296 7.92216H5.97439H7.02713H7.36856L7.37702 7.58083L7.47728 3.537L7.48617 3.17832H7.12739H5.87413ZM6.50076 10.0109C7.06121 10.0109 7.5317 9.57872 7.5317 9.00504C7.5317 8.43137 7.06121 7.99918 6.50076 7.99918C5.94031 7.99918 5.46982 8.43137 5.46982 9.00504C5.46982 9.57872 5.94031 10.0109 6.50076 10.0109Z" fill="white" stroke="#EB001B" stroke-width="0.7">
    </symbol>
  </svg>
  
  <h1>{{ 'customer.register.title' | t }}</h1>
  
  {%- form 'create_customer' -%}
    <!-- Registration Type Selector -->
    <div class="registration-type-selector">
      <h3>I am registering as:</h3>
      <div class="registration-type-options">
        <label>
          <input type="radio" name="registration_type" value="consumer" id="registration-type-consumer" checked>
          <span>Consumer</span>
        </label>
        <label>
          <input type="radio" name="registration_type" value="hcp" id="registration-type-hcp">
          <span>Healthcare Provider</span>
        </label>
      </div>
    </div>

    <!-- Hidden field to store registration type -->
    <input type="hidden" name="customer[note][Registration Type]" id="registration-type-hidden" value="consumer">
    {%- if request.params.return_url -%}
    <input type="hidden" name="return_url" value="{{ request.params.return_url | url_encode }}">
    {%- elsif request.referer -%}
      <input type="hidden" name="return_url" value="{{ request.referer | url_encode }}">
    {%- else -%}
      <input type="hidden" name="return_url" value="{{ routes.account_url }}">
    {%- endif -%}
    {%- if form.errors -%}
      <h2 class="form__message" tabindex="-1" autofocus>
        <svg aria-hidden="true" focusable="false">
          <use href="#icon-error" />
        </svg>
        {{ 'templates.contact.form.error_heading' | t }}
      </h2>
      <ul>
        {%- for field in form.errors -%}
          <li>
            {%- if field == 'form' -%}
              {{ form.errors.messages[field] }}
            {%- else -%}
              <a href="#RegisterForm-{{ field }}">
                {{ form.errors.translated_fields[field] | capitalize }}
                {{ form.errors.messages[field] }}
              </a>
            {%- endif -%}
          </li>
        {%- endfor -%}
      </ul>
    {%- endif -%}

    <div class="field">
      <input type="text" name="customer[first_name]" id="RegisterForm-FirstName" 
             {% if form.first_name %}value="{{ form.first_name }}"{% endif %}
             autocomplete="given-name" placeholder="{{ 'customer.register.first_name' | t }}">
      <label for="RegisterForm-FirstName">{{ 'customer.register.first_name' | t }}</label>
    </div>

    <div class="field">
      <input type="text" name="customer[last_name]" id="RegisterForm-LastName" 
             {% if form.last_name %}value="{{ form.last_name }}"{% endif %}
             autocomplete="family-name" placeholder="{{ 'customer.register.last_name' | t }}">
      <label for="RegisterForm-LastName">{{ 'customer.register.last_name' | t }}</label>
    </div>

    <div class="field">
      <input type="email" name="customer[email]" id="RegisterForm-email" 
             {% if form.email %}value="{{ form.email }}"{% endif %}
             spellcheck="false" autocapitalize="off" autocomplete="email" aria-required="true"
             {% if form.errors contains 'email' %}aria-invalid="true" aria-describedby="RegisterForm-email-error"{% endif %}
             placeholder="{{ 'customer.register.email' | t }}">
      <label for="RegisterForm-email">{{ 'customer.register.email' | t }}</label>
    </div>
    {%- if form.errors contains 'email' -%}
      <span id="RegisterForm-email-error" class="form__message">
        <svg aria-hidden="true" focusable="false"><use href="#icon-error" /></svg>
        {{ form.errors.translated_fields.email | capitalize }} {{ form.errors.messages.email }}.
      </span>
    {%- endif -%}

    <div class="field">
      <input type="password" name="customer[password]" id="RegisterForm-password" aria-required="true"
             {% if form.errors contains 'password' %}aria-invalid="true" aria-describedby="RegisterForm-password-error"{% endif %}
             placeholder="{{ 'customer.register.password' | t }}">
      <label for="RegisterForm-password">{{ 'customer.register.password' | t }}</label>
    </div>
    {%- if form.errors contains 'password' -%}
      <span id="RegisterForm-password-error" class="form__message">
        <svg aria-hidden="true" focusable="false"><use href="#icon-error" /></svg>
        {{ form.errors.translated_fields.password | capitalize }} {{ form.errors.messages.password }}.
      </span>
    {%- endif -%}

    <!-- HCP-specific fields (hidden by default, shown when HCP is selected) -->
    <div class="hcp-fields" id="hcp-fields-container">
      <div class="field">
        <input type="text" name="customer[note][Company Name]" id="RegisterForm-CompanyName" 
               placeholder="Company Name">
        <label for="RegisterForm-CompanyName">Company Name <span style="color: red;">*</span></label>
      </div>
      
      <div class="field">
        <input type="text" name="customer[note][NPI Number]" id="RegisterForm-NPINumber" 
               placeholder="NPI Number">
        <label for="RegisterForm-NPINumber">NPI Number <span style="color: red;">*</span></label>
      </div>

      <br>
      <div class="checkbox-row">
        <input type="checkbox" id="RegisterForm-Reseller" name="customer[note][Reseller]" value="Yes">
        <label for="RegisterForm-Reseller">
          I am a reseller and can upload my reseller certificate.
        </label>
      </div>

      <!-- Hidden field to store the uploaded file URL -->
      <input type="hidden" name="customer[note][Reseller Certificate URL]" id="certificate-url">

      <!-- File Upload Container -->
      <div class="file-upload-container" id="reseller-certificate-upload">
        <h4>Upload Reseller Certificate</h4>
        <button type="button" id="upload-btn" class="upload-btn">Choose Certificate File</button>
        <div class="file-info" id="certificate-info"></div>
        <small>Accepted formats: PDF, JPG, PNG (max 20MB)</small>
      </div>
    </div>

    <p id="terms-policy-text"><small>By clicking Create, you agree to The Akkermansia Company's Terms & Conditions, MAP Policy, and Authorized Reseller Policy.</small></p>
    
    <button type="submit" id="submit-btn">{{ 'customer.register.submit' | t }}</button>
  {%- endform -%}
</div>

<!-- Cloudinary Upload Widget -->
<script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript" async></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Registration type toggle elements
  const registrationTypeConsumer = document.getElementById('registration-type-consumer');
  const registrationTypeHcp = document.getElementById('registration-type-hcp');
  const registrationTypeHidden = document.getElementById('registration-type-hidden');
  const hcpFieldsContainer = document.getElementById('hcp-fields-container');
  const companyNameField = document.getElementById('RegisterForm-CompanyName');
  const npiNumberField = document.getElementById('RegisterForm-NPINumber');
  const termsPolicyText = document.getElementById('terms-policy-text');
  
  // Reseller and upload elements
  const resellerCheckbox = document.getElementById('RegisterForm-Reseller');
  const uploadContainer = document.getElementById('reseller-certificate-upload');
  const uploadBtn = document.getElementById('upload-btn');
  const infoDiv = document.getElementById('certificate-info');
  const certificateUrlInput = document.getElementById('certificate-url');
  const form = document.querySelector('form');
  const submitBtn = document.getElementById('submit-btn');

  // ===== NEW: capture intended return URL =====
  const params = new URLSearchParams(window.location.search);
  const rawReturnTo =
    params.get('return_to') ||
    document.referrer ||
    (window.location.pathname + window.location.search + window.location.hash);

  function sanitizeReturnTo(raw) {
    try {
      // allow relative paths outright
      if (!/^https?:\/\//i.test(raw)) return raw || '/';
      const u = new URL(raw, window.location.origin);
      if (u.origin !== window.location.origin) return '/';
      return u.pathname + u.search + u.hash || '/';
    } catch(e) { return '/'; }
  }
  const returnTo = sanitizeReturnTo(rawReturnTo);
  // ===========================================

  // Function to toggle HCP fields visibility
  function toggleHcpFields(isHcp) {
    if (isHcp) {
      hcpFieldsContainer.classList.add('show');
      // Make HCP fields required
      if (companyNameField) {
        companyNameField.setAttribute('required', 'required');
      }
      if (npiNumberField) {
        npiNumberField.setAttribute('required', 'required');
      }
      registrationTypeHidden.value = 'hcp';
      // Show terms text for HCP
      if (termsPolicyText) {
        termsPolicyText.style.display = 'block';
      }
    } else {
      hcpFieldsContainer.classList.remove('show');
      // Remove required attribute from HCP fields
      if (companyNameField) {
        companyNameField.removeAttribute('required');
        companyNameField.value = '';
      }
      if (npiNumberField) {
        npiNumberField.removeAttribute('required');
        npiNumberField.value = '';
      }
      // Reset reseller checkbox and upload
      if (resellerCheckbox) {
        resellerCheckbox.checked = false;
      }
      if (uploadContainer) {
        uploadContainer.classList.remove('show');
      }
      if (certificateUrlInput) {
        certificateUrlInput.value = '';
      }
      if (infoDiv) {
        infoDiv.innerHTML = '';
        infoDiv.className = 'file-info';
      }
      if (uploadBtn) {
        uploadBtn.textContent = 'Choose Certificate File';
        uploadBtn.disabled = false;
      }
      uploadedFileUrl = '';
      registrationTypeHidden.value = 'consumer';
      // Hide terms text for Consumer
      if (termsPolicyText) {
        termsPolicyText.style.display = 'none';
      }
    }
  }

  // Handle registration type change
  if (registrationTypeConsumer && registrationTypeHcp) {
    registrationTypeConsumer.addEventListener('change', function() {
      if (this.checked) {
        toggleHcpFields(false);
      }
    });

    registrationTypeHcp.addEventListener('change', function() {
      if (this.checked) {
        toggleHcpFields(true);
      }
    });

    // Initialize based on default selection (consumer)
    toggleHcpFields(false);
  }

  const CLOUDINARY_CLOUD_NAME = 'dacv4ke6z';  // Get from Cloudinary dashboard
  const CLOUDINARY_UPLOAD_PRESET = 'reseller_documents';  // Your preset name

  let uploadedFileUrl = '';
  let uploadWidget = null;

  // Initialize Cloudinary upload widget
  function initializeUploadWidget() {
    uploadWidget = cloudinary.createUploadWidget({
      cloudName: CLOUDINARY_CLOUD_NAME,
      uploadPreset: CLOUDINARY_UPLOAD_PRESET,
      multiple: false,
      maxFileSize: 20000000, // 20MB
      clientAllowedFormats: ['pdf', 'jpg', 'png', 'jpeg'],
      folder: 'reseller-documents',
      sources: ['local'],
      showAdvancedOptions: false,
      cropping: false,
      theme: 'minimal'
    }, function(error, result) {
      if (error) {
        console.error('Upload error:', error);
        showFileError('Upload failed: ' + error.message);
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Choose Certificate File';
        return;
      }

      if (result.event === 'success') {
        uploadedFileUrl = result.info.secure_url;
        const fileName = result.info.original_filename + '.' + result.info.format;
        
        // Store URL in hidden input
        certificateUrlInput.value = uploadedFileUrl;
        
        // Update UI
        infoDiv.innerHTML = `✅ ${fileName} uploaded successfully`;
        infoDiv.className = 'file-info success';
        uploadBtn.textContent = '✅ Certificate Uploaded';
        uploadBtn.disabled = true;
        
        console.log('File uploaded successfully:', uploadedFileUrl);
      }

      if (result.event === 'upload-added') {
        uploadBtn.textContent = 'Uploading...';
        uploadBtn.disabled = true;
        infoDiv.innerHTML = 'Uploading file...';
        infoDiv.className = 'file-info';
      }
    });
  }

  // Show/hide file upload when reseller checkbox changes
  resellerCheckbox.addEventListener('change', function() {
    if (this.checked) {
      uploadContainer.classList.add('show');
      if (!uploadWidget) {
        initializeUploadWidget();
      }
    } else {
      uploadContainer.classList.remove('show');
      // Clear uploaded file data
      uploadedFileUrl = '';
      certificateUrlInput.value = '';
      infoDiv.innerHTML = '';
      infoDiv.className = 'file-info';
      uploadBtn.textContent = 'Choose Certificate File';
      uploadBtn.disabled = false;
    }
  });

  // Handle upload button click
  uploadBtn.addEventListener('click', function() {
    if (uploadWidget) {
      uploadWidget.open();
    } else {
      showFileError('Upload widget not initialized. Please try again.');
    }
  });

  // Form submission validation
  form.addEventListener('submit', function(e) {
    const isHcp = registrationTypeHcp && registrationTypeHcp.checked;
    
    // Validate HCP fields only if HCP is selected
    if (isHcp) {
      // Check required HCP fields
      if (companyNameField && !companyNameField.value.trim()) {
        e.preventDefault();
        alert('Please enter your Company Name.');
        companyNameField.focus();
        return false;
      }
      
      if (npiNumberField && !npiNumberField.value.trim()) {
        e.preventDefault();
        alert('Please enter your NPI Number.');
        npiNumberField.focus();
        return false;
      }
      
      // If reseller is checked but no file uploaded
      if (resellerCheckbox && resellerCheckbox.checked && !uploadedFileUrl) {
        e.preventDefault();
        alert('Please upload your reseller certificate before submitting.');
        uploadBtn.focus();
        return false;
      }
    }

    // ===== NEW: stash the return target for after-auth redirect =====
    try { localStorage.setItem('return_to_after_auth', returnTo); } catch(e) {}
    // ================================================================

    // Show loading state
    submitBtn.textContent = 'Creating Account...';
    submitBtn.disabled = true;
    
    // Note: The form will submit normally to Shopify
    // The file URL is now stored in customer[note][Reseller Certificate URL]
  });

  function showFileError(message) {
    infoDiv.innerHTML = '⚠️ ' + message;
    infoDiv.className = 'file-info error';
  }
});
</script>