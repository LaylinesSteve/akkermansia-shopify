{% comment %}
  Renders a restricted buy button that only shows pricing to customers with a specific tag.
  Accepts:
  - product: {Object} product object.
  - block: {Object} passing the block information.
  - product_form_id: {String} product form id.
  - section_id: {String} id of section to which this snippet belongs.

  Usage:
  {% render 'restricted-buy-button', product: product, block: block, product_form_id: product_form_id, section_id: section.id %}
{% endcomment %}

<div 
  class="restricted-buy-button" 
  {{ block.shopify_attributes }}
>
  {%- assign current_variant = product.selected_or_first_available_variant -%}
  {%- assign required_tag = block.settings.required_customer_tag | strip -%}
  {%- assign has_access = false -%}
  {%- assign is_logged_in = false -%}
  
  {%- if customer -%}
    {%- assign is_logged_in = true -%}
    {%- if required_tag == blank -%}
      {%- comment -%} If no tag specified, allow any logged-in customer {%- endcomment -%}
      {%- assign has_access = true -%}
    {%- elsif customer.tags contains required_tag -%}
      {%- assign has_access = true -%}
    {%- endif -%}
  {%- endif -%}

  {%- if has_access -%}
    {%- comment -%} Show pricing and buy button for authorized users {%- endcomment -%}
    {%- liquid
      assign button_color = block.settings.button_color | default: '#5B3C94'
      assign button_border_radius = block.settings.button_border_radius | default: 8
      assign button_font_size = block.settings.button_font_size | default: 16
    -%}
    <product-form
      class="product-form"
      data-section-id="{{ section_id }}"
    >
      <div class="product-form__error-message-wrapper" role="alert" hidden>
        <svg
          aria-hidden="true"
          focusable="false"
          class="icon icon-error"
          viewBox="0 0 13 13"
        >
          <circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
          <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
          <path d="M5.87413 3.52832L5.97439 7.57216H7.02713L7.12739 3.52832H5.87413ZM6.50076 9.66091C6.88091 9.66091 7.18169 9.37267 7.18169 9.00504C7.18169 8.63742 6.88091 8.34917 6.50076 8.34917C6.12061 8.34917 5.81982 8.63742 5.81982 9.00504C5.81982 9.37267 6.12061 9.66091 6.50076 9.66091Z" fill="white"/>
          <path d="M5.87413 3.17832H5.51535L5.52424 3.537L5.6245 7.58083L5.63296 7.92216H5.97439H7.02713H7.36856L7.37702 7.58083L7.47728 3.537L7.48617 3.17832H7.12739H5.87413ZM6.50076 10.0109C7.06121 10.0109 7.5317 9.57872 7.5317 9.00504C7.5317 8.43137 7.06121 7.99918 6.50076 7.99918C5.94031 7.99918 5.46982 8.43137 5.46982 9.00504C5.46982 9.57872 5.94031 10.0109 6.50076 10.0109Z" fill="white" stroke="#EB001B" stroke-width="0.7">
        </svg>
        <span class="product-form__error-message"></span>
      </div>

      {%- form 'product',
        product,
        id: product_form_id,
        class: 'form',
        novalidate: 'novalidate',
        data-type: 'add-to-cart-form'
      -%}
        <input
          type="hidden"
          name="id"
          value="{{ current_variant.id }}"
          {% if current_variant.available == false %}
            disabled
          {% endif %}
          class="product-variant-id"
        >
        <input
          type="hidden"
          name="quantity"
          value="12"
          id="RestrictedQuantityHidden-{{ section_id }}"
        >

        <div class="restricted-buy-button__pricing">
          {% render 'price', product: product, use_variant: true, price_class: 'restricted-buy-button__price' %}
        </div>

        <div class="restricted-buy-button__quantity product-form__input product-form__quantity">
          <label class="quantity__label form__label" for="RestrictedQuantity-{{ section_id }}">
            {{ 'products.product.quantity.label' | t }}
            <span class="quantity__info">
              (Order in cartons of 12)
            </span>
          </label>
          <quantity-input class="quantity">
            <button class="quantity__button" name="minus" type="button">
              <span class="visually-hidden">
                {{- 'products.product.quantity.decrease' | t: product: product.title | escape -}}
              </span>
              {% render 'icon-minus' %}
            </button>
            <input
              class="quantity__input"
              type="number"
              name="quantity"
              id="RestrictedQuantity-{{ section_id }}"
              value="12"
              min="12"
              step="12"
              data-min="12"
              form="{{ product_form_id }}"
              aria-label="{{ 'products.product.quantity.input_label' | t: product: product.title | escape }}"
            >
            <button class="quantity__button" name="plus" type="button">
              <span class="visually-hidden">
                {{- 'products.product.quantity.increase' | t: product: product.title | escape -}}
              </span>
              {% render 'icon-plus' %}
            </button>
          </quantity-input>
        </div>

        <div class="product-form__buttons" style="--hcp-button-color: {{ button_color }}; --hcp-button-radius: {{ button_border_radius }}px; --hcp-button-font-size: {{ button_font_size }}px;">
          {%- liquid
            assign check_against_inventory = true
            if current_variant.inventory_management != 'shopify' or current_variant.inventory_policy == 'continue'
              assign check_against_inventory = false
            endif
            assign quantity_rule_soldout = false
            if current_variant.quantity_rule.min > current_variant.inventory_quantity and check_against_inventory
              assign quantity_rule_soldout = true
            endif
          -%}
          <button
            id="RestrictedProductSubmitButton-{{ section_id }}"
            type="submit"
            name="add"
            class="restricted-buy-button__submit product-form__submit button button--full-width button--primary"
            {% if current_variant.available == false or quantity_rule_soldout %}
              disabled
            {% endif %}
          >
            <span>
              {%- if current_variant.available == false or quantity_rule_soldout -%}
                {{ 'products.product.sold_out' | t }}
              {%- else -%}
                {{ 'products.product.add_to_cart' | t }}
              {%- endif -%}
            </span>
            {%- render 'loading-spinner' -%}
          </button>
          {%- if block.settings.show_dynamic_checkout -%}
            {{ form | payment_button }}
          {%- endif -%}
        </div>
      {%- endform -%}
    </product-form>
    <script>
      (function() {
        const form = document.getElementById('{{ product_form_id }}');
        if (form) {
          form.addEventListener('submit', function(e) {
            // Force quantity to 12 on form submit
            const quantityInput = document.getElementById('RestrictedQuantity-{{ section_id }}');
            if (quantityInput) {
              quantityInput.value = '12';
            }
            // Also update hidden input if it exists
            const hiddenQuantityInput = document.getElementById('RestrictedQuantityHidden-{{ section_id }}');
            if (hiddenQuantityInput) {
              hiddenQuantityInput.value = '12';
            }
          });
        }
      })();
    </script>
  {%- else -%}
    {%- comment -%} Show restricted access message {%- endcomment -%}
    <div class="restricted-buy-button__restricted">
      {%- unless is_logged_in -%}
        {%- comment -%} Not logged in - show sign in button {%- endcomment -%}
        <a 
          href="{{ routes.account_login_url }}?return_to={{ request.path | url_encode }}" 
          class="restricted-buy-button__sign-in-button"
        >
          Sign in to See Pricing
        </a>
        <p class="restricted-buy-button__register-text">
          Need an account? <a href="{{ routes.account_register_url }}?return_to={{ request.path | url_encode }}">Register here</a>
        </p>
      {%- else -%}
        {%- comment -%} Logged in but doesn't have required tag {%- endcomment -%}
        <a 
          href="{{ routes.account_login_url }}?return_to={{ request.path | url_encode }}" 
          class="restricted-buy-button__sign-in-button"
        >
          Sign in to See Pricing
        </a>
        <p class="restricted-buy-button__register-text">
          This product requires special access. <a href="{{ routes.account_register_url }}">Contact us</a> to learn more.
        </p>
      {%- endunless -%}
    </div>
  {%- endif -%}
</div>
