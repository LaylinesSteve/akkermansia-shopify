{% comment %}
  Renders Loop subscription widget with tabs for Subscribe & save and One-time purchase.
  Accepts:
  - product: {Object} product object.
  - block: {Object} passing the block information.
  - product_form_id: {String} product form id.
  - section_id: {String} id of section to which this snippet belongs.

  Usage:
  {% render 'loop-subscription-widget', product: product, block: block, product_form_id: product_form_id, section_id: section.id %}
{% endcomment %}

<loop-subscription-widget
  class="loop-subscription-widget" 
  data-product-id="{{ product.id }}"
  data-variant-id="{{ product.selected_or_first_available_variant.id }}"
  data-section-id="{{ section_id }}"
  {{ block.shopify_attributes }}
>
  {%- assign current_variant = product.selected_or_first_available_variant -%}
  {%- assign one_time_price = current_variant.price | money -%}
  
  {%- comment -%} Pass selling plans data from Liquid to JavaScript {%- endcomment -%}
  <script type="application/json" data-selling-plans-data>
  {
    "productId": {{ product.id | json }},
    "variantId": {{ current_variant.id | json }},
    "variantPrice": {{ current_variant.price | json }},
    "sellingPlanGroups": [
      {%- for group in product.selling_plan_groups -%}
        {
          "id": {{ group.id | json }},
          "name": {{ group.name | json }},
          "options": {{ group.options | json }},
          "sellingPlans": [
            {%- for plan in group.selling_plans -%}
              {
                "id": {{ plan.id | json }},
                "name": {{ plan.name | json }},
                "description": {{ plan.description | default: '' | json }},
                "options": [
                  {%- for option in plan.options -%}
                    {
                      "name": {{ option.name | json }},
                      "values": {{ option.values | json }}
                    }{%- unless forloop.last -%},{%- endunless -%}
                  {%- endfor -%}
                ],
                "priceAdjustments": [
                  {%- for adjustment in plan.price_adjustments -%}
                    {
                      "valueType": {{ adjustment.value_type | json }},
                      "value": {{ adjustment.value | json }}
                    }{%- unless forloop.last -%},{%- endunless -%}
                  {%- endfor -%}
                ]
              }{%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}
          ]
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  }
  </script>

  <div class="loop-subscription-widget__tabs">
    <button 
      type="button"
      class="loop-subscription-widget__tab loop-subscription-widget__tab--subscribe active"
      data-tab="subscribe"
      aria-selected="true"
    >
      Subscribe & save
    </button>
    <button 
      type="button"
      class="loop-subscription-widget__tab loop-subscription-widget__tab--onetime"
      data-tab="onetime"
      aria-selected="false"
    >
      One-time purchase
    </button>
  </div>

  <div class="loop-subscription-widget__content">
    {%- comment -%} Subscribe & Save Tab Content {%- endcomment -%}
    <div class="loop-subscription-widget__panel loop-subscription-widget__panel--subscribe active" data-panel="subscribe">
      <div class="loop-subscription-widget__options" id="loop-subscription-options-{{ section_id }}">
        {%- comment -%} Subscription options will be populated by JavaScript from Loop API {%- endcomment -%}
        <div class="loop-subscription-widget__loading">
          <span class="loading__spinner"></span>
          <span>Loading subscription options...</span>
        </div>
        <div class="loop-subscription-widget__no-subscriptions hidden">
          <p>No subscription options available for this product.</p>
        </div>
      </div>
    </div>

    {%- comment -%} One-time Purchase Tab Content {%- endcomment -%}
    <div class="loop-subscription-widget__panel loop-subscription-widget__panel--onetime" data-panel="onetime">
      <div class="loop-subscription-widget__onetime-option">
        <label class="loop-subscription-widget__radio-label">
          <input 
            type="radio" 
            name="loop-purchase-type-{{ section_id }}" 
            value="onetime"
            class="loop-subscription-widget__radio"
            data-purchase-type="onetime"
          >
          <span class="loop-subscription-widget__radio-custom"></span>
          <div class="loop-subscription-widget__option-content">
            <span class="loop-subscription-widget__option-title">1-Month supply (one-time purchase)</span>
            <span class="loop-subscription-widget__option-price" data-onetime-price="{{ one_time_price }}">
              {{ one_time_price }}
            </span>
          </div>
        </label>
        <button 
          type="button"
          class="loop-subscription-widget__switch-to-subscribe"
          data-action="switch-to-subscribe"
        >
          Subscribe & save up to 31%
        </button>
      </div>
      <div class="loop-subscription-widget__shipping-info">
        <p>$9.99 shipping & processing for one-time purchases.</p>
      </div>
    </div>
  </div>

  {%- comment -%} Action Buttons {%- endcomment -%}
  {%- liquid
    assign button_color = block.settings.button_color | default: '#5B3C94'
    assign button_border_radius = block.settings.button_border_radius | default: 8
    assign button_font_size = block.settings.button_font_size | default: 16
  -%}
  <product-form
    class="product-form loop-subscription-widget__product-form"
    data-section-id="{{ section_id }}"
  >
    {%- form 'product',
      product,
      id: product_form_id,
      class: 'form loop-subscription-widget__form',
      novalidate: 'novalidate',
      data-type: 'add-to-cart-form',
      data-loop-form: ''
    -%}
      {%- assign current_product = product -%}
      <input
        type="hidden"
        name="id"
        value="{{ current_variant.id }}"
        data-variant-input
        class="product-variant-id"
      >
      <input type="hidden" name="quantity" value="1" data-quantity-input data-loop-quantity min="1" step="1">
      <input type="hidden" name="selling_plan" value="" data-selling-plan-input>

      <div class="loop-subscription-widget__actions product-form__buttons" style="--loop-button-color: {{ button_color }}; --loop-button-radius: {{ button_border_radius }}px; --loop-button-font-size: {{ button_font_size }}px;">
        <button
          type="submit"
          name="add"
          class="loop-subscription-widget__add-to-cart product-form__submit button button--primary button--full-width"
          data-action="add-to-cart"
          {% unless current_variant.available %}disabled{% endunless %}
        >
          <span class="loop-subscription-widget__button-text">
            {%- if current_variant.available -%}
              Add to cart
            {%- else -%}
              {{ 'products.product.sold_out' | t }}
            {%- endif -%}
          </span>
          {%- render 'loading-spinner' -%}
        </button>
        
        {{ form | payment_button }}

        <div class="loop-subscription-widget__fsa-badge">
          FSA/HSA Eligible
        </div>
        
        <div class="loop-subscription-widget__shipping-info" style="margin-top: 16px;">
          <p>Free shipping on subscription orders. Money-back guarantee.</p>
        </div>
      </div>
    {%- endform -%}
  </product-form>
</loop-subscription-widget>
